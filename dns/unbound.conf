# Unbound configuration for DN42 + NextDNS
# This config forwards non-DN42 queries to NextDNS and resolves DN42 domains using DN42 anycast
# Authoritative zones are served by NSD on the same machine

server:
    # Listen on specific interface (not 0.0.0.0 to avoid conflict with systemd-resolved)
    interface: 192.168.1.176
    interface: 2a0a:a543:d3f3:80:be24:11ff:fe5d:a0dc

    # Interface settings
    do-ip4: yes
    do-ip6: yes

    # Allow queries only from local network (192.168.1.x) and localhost
    access-control: 0.0.0.0/0 refuse
    access-control: ::/0 refuse
    access-control: 192.168.1.0/24 allow
    access-control: 127.0.0.0/8 allow
    access-control: ::1 allow
    access-control: 2a0a:a543:d3f3:80::/64 allow

    # Allow DN42 networks to query (they will reach NSD directly)
    access-control: 172.20.0.0/14 allow
    access-control: 10.0.0.0/8 allow
    access-control: fd00::/8 allow
    access-control: fd30:366:4000::/48 allow

    # Performance and security settings
    num-threads: 2
    msg-cache-size: 128m
    rrset-cache-size: 256m
    cache-min-ttl: 300
    cache-max-ttl: 86400

    # Privacy settings
    hide-identity: yes
    hide-version: yes

    # Disable DNSSEC validation for DN42 (they have their own DNSSEC setup)
    domain-insecure: "dn42"
    domain-insecure: "20.172.in-addr.arpa"
    domain-insecure: "21.172.in-addr.arpa"
    domain-insecure: "22.172.in-addr.arpa"
    domain-insecure: "23.172.in-addr.arpa"
    domain-insecure: "10.in-addr.arpa"
    domain-insecure: "d.f.ip6.arpa"

    # Allow localhost queries (for NSD stub zones)
    do-not-query-localhost: no

    # Use DN42 interface for outgoing queries to DN42
    outgoing-interface: 172.20.13.1

    # Private address ranges (don't return these from public DNS)
    # Note: DN42 ranges (172.20.0.0/14, 10.0.0.0/8, fd00::/8) are NOT marked private
    # so that DN42 DNS can return them
    private-address: 192.168.0.0/16
    private-address: 169.254.0.0/16

    # Disable default handling for DN42 zones (required for forwarding to work)
    local-zone: "20.172.in-addr.arpa." nodefault
    local-zone: "21.172.in-addr.arpa." nodefault
    local-zone: "22.172.in-addr.arpa." nodefault
    local-zone: "23.172.in-addr.arpa." nodefault
    local-zone: "10.in-addr.arpa." nodefault
    local-zone: "d.f.ip6.arpa." nodefault

    # Allow DN42 domains to return private addresses
    private-domain: "dn42"
    private-domain: "20.172.in-addr.arpa"
    private-domain: "21.172.in-addr.arpa"
    private-domain: "22.172.in-addr.arpa"
    private-domain: "23.172.in-addr.arpa"
    private-domain: "10.in-addr.arpa"
    private-domain: "d.f.ip6.arpa"

# Forward all non-DN42 queries to NextDNS
forward-zone:
    name: "."
    forward-addr: 45.90.28.169
    forward-addr: 45.90.30.169
    forward-addr: 2a07:a8c0::21:d1bc
    forward-addr: 2a07:a8c1::21:d1bc

# DN42 domains - use DN42 anycast resolvers
# Note: Anycast DNS may take time to become reachable as BGP routes propagate
# The anycast addresses will automatically work once the network converges
forward-zone:
    name: "dn42"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# Reverse DNS for DN42 IPv4 ranges
forward-zone:
    name: "20.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "21.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "22.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "23.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "10.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# Reverse DNS for DN42 IPv6 range (fd00::/8)
forward-zone:
    name: "d.f.ip6.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# Other DN42 affiliated TLDs (based on DN42 wiki)
forward-zone:
    name: "neo"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "hack"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# ========================================
# STUB ZONES - Forward to local NSD authoritative server
# These are our authoritative zones served by NSD
# ========================================

# scarjit.dn42 - served by NSD on 172.20.13.1
stub-zone:
    name: "scarjit.dn42"
    stub-addr: 172.20.13.1

# linnenberg.dn42 - served by NSD on 172.20.13.2
stub-zone:
    name: "linnenberg.dn42"
    stub-addr: 172.20.13.2

# IPv4 reverse DNS for 172.20.13.0/27 - served by NSD
stub-zone:
    name: "13.20.172.in-addr.arpa"
    stub-addr: 172.20.13.1

# IPv6 reverse DNS for fd30:366:4000::/48 - served by NSD
stub-zone:
    name: "0.0.0.4.6.6.3.0.0.3.d.f.ip6.arpa"
    stub-addr: 172.20.13.1
