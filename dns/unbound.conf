# Unbound configuration for DN42 + NextDNS
# This config forwards non-DN42 queries to NextDNS and resolves DN42 domains using DN42 anycast

server:
    # Listen on specific interface (not 0.0.0.0 to avoid conflict with systemd-resolved)
    interface: 192.168.1.176
    interface: 2a0a:a543:d3f3:80:be24:11ff:fe5d:a0dc
    interface: 172.20.13.1  # DN42 dummy interface - scarjit.dn42 NS
    interface: 172.20.13.2  # DN42 dummy interface - linnenberg.dn42 NS
    interface: fd30:366:4000::1  # DN42 IPv6 - scarjit.dn42 NS
    interface: fd30:366:4000::2  # DN42 IPv6 - linnenberg.dn42 NS

    # Allow queries only from local network (192.168.1.x) and localhost
    access-control: 0.0.0.0/0 refuse
    access-control: ::0/0 refuse
    access-control: 192.168.1.0/24 allow
    access-control: 127.0.0.0/8 allow
    access-control: ::1 allow
    access-control: 2a0a:a543:d3f3:80::/64 allow

    # Allow DN42 networks to query our authoritative zones
    access-control: 172.20.0.0/14 allow
    access-control: 10.0.0.0/8 allow
    access-control: fd00::/8 allow

    # Performance and security settings
    num-threads: 2
    msg-cache-size: 128m
    rrset-cache-size: 256m
    cache-min-ttl: 300
    cache-max-ttl: 86400

    # Privacy settings
    hide-identity: yes
    hide-version: yes

    # Disable DNSSEC validation for DN42 (they have their own DNSSEC setup)
    domain-insecure: "dn42"
    domain-insecure: "20.172.in-addr.arpa"
    domain-insecure: "21.172.in-addr.arpa"
    domain-insecure: "22.172.in-addr.arpa"
    domain-insecure: "23.172.in-addr.arpa"
    domain-insecure: "10.in-addr.arpa"
    domain-insecure: "d.f.ip6.arpa"

    # Do not query localhost
    do-not-query-localhost: no

    # Use DN42 interface for outgoing queries to DN42
    outgoing-interface: 172.20.13.1

    # Private address ranges (don't return these from public DNS)
    # Note: DN42 ranges (172.20.0.0/14, 10.0.0.0/8, fd00::/8) are NOT marked private
    # so that DN42 DNS can return them
    private-address: 192.168.0.0/16
    private-address: 169.254.0.0/16

    # Disable default handling for DN42 zones (required for forwarding to work)
    local-zone: "20.172.in-addr.arpa." nodefault
    local-zone: "21.172.in-addr.arpa." nodefault
    local-zone: "22.172.in-addr.arpa." nodefault
    local-zone: "23.172.in-addr.arpa." nodefault
    local-zone: "10.in-addr.arpa." nodefault
    local-zone: "d.f.ip6.arpa." nodefault

    # Allow DN42 domains to return private addresses
    private-domain: "dn42"
    private-domain: "20.172.in-addr.arpa"
    private-domain: "21.172.in-addr.arpa"
    private-domain: "22.172.in-addr.arpa"
    private-domain: "23.172.in-addr.arpa"
    private-domain: "10.in-addr.arpa"
    private-domain: "d.f.ip6.arpa"

    # ========================================
    # AUTHORITATIVE ZONES - scarjit.dn42
    # ========================================
    local-zone: "scarjit.dn42." static

    # SOA record for scarjit.dn42
    local-data: "scarjit.dn42. 3600 IN SOA ns1.scarjit.dn42. ferdinand.linnenberg.dev. 2025102001 7200 3600 1209600 3600"

    # NS record
    local-data: "scarjit.dn42. 3600 IN NS ns1.scarjit.dn42."

    # Nameserver addresses
    local-data: "ns1.scarjit.dn42. 3600 IN A 172.20.13.1"
    local-data: "ns1.scarjit.dn42. 3600 IN AAAA fd30:366:4000::1"

    # Main domain records
    local-data: "scarjit.dn42. 3600 IN A 172.20.13.1"
    local-data: "scarjit.dn42. 3600 IN AAAA fd30:366:4000::1"

    # ========================================
    # AUTHORITATIVE ZONES - linnenberg.dn42
    # ========================================
    local-zone: "linnenberg.dn42." static

    # SOA record for linnenberg.dn42
    local-data: "linnenberg.dn42. 3600 IN SOA ns1.linnenberg.dn42. ferdinand.linnenberg.dev. 2025102001 7200 3600 1209600 3600"

    # NS record
    local-data: "linnenberg.dn42. 3600 IN NS ns1.linnenberg.dn42."

    # Nameserver addresses
    local-data: "ns1.linnenberg.dn42. 3600 IN A 172.20.13.2"
    local-data: "ns1.linnenberg.dn42. 3600 IN AAAA fd30:366:4000::2"

    # Main domain records
    local-data: "linnenberg.dn42. 3600 IN A 172.20.13.2"
    local-data: "linnenberg.dn42. 3600 IN AAAA fd30:366:4000::2"

    # ========================================
    # REVERSE DNS - IPv4 (172.20.13.0/27)
    # ========================================
    # Reverse zone for 172.20.13.0/27
    local-zone: "13.20.172.in-addr.arpa." static

    # SOA for reverse zone
    local-data: "13.20.172.in-addr.arpa. 3600 IN SOA ns1.scarjit.dn42. ferdinand.linnenberg.dev. 2025102001 7200 3600 1209600 3600"

    # NS records for reverse zone
    local-data: "13.20.172.in-addr.arpa. 3600 IN NS ns1.scarjit.dn42."
    local-data: "13.20.172.in-addr.arpa. 3600 IN NS ns1.linnenberg.dn42."

    # PTR records for nameservers and key hosts
    local-data: "1.13.20.172.in-addr.arpa. 3600 IN PTR ns1.scarjit.dn42."
    local-data: "2.13.20.172.in-addr.arpa. 3600 IN PTR ns1.linnenberg.dn42."

    # ========================================
    # REVERSE DNS - IPv6 (fd30:366:4000::/48)
    # ========================================
    # Reverse zone for fd30:366:4000::/48
    # Format: 0.0.0.4.6.6.3.0.3.d.f.ip6.arpa
    local-zone: "0.0.0.4.6.6.3.0.3.d.f.ip6.arpa." static

    # SOA for IPv6 reverse zone
    local-data: "0.0.0.4.6.6.3.0.3.d.f.ip6.arpa. 3600 IN SOA ns1.scarjit.dn42. ferdinand.linnenberg.dev. 2025102001 7200 3600 1209600 3600"

    # NS records for IPv6 reverse zone
    local-data: "0.0.0.4.6.6.3.0.3.d.f.ip6.arpa. 3600 IN NS ns1.scarjit.dn42."
    local-data: "0.0.0.4.6.6.3.0.3.d.f.ip6.arpa. 3600 IN NS ns1.linnenberg.dn42."

    # PTR records for IPv6 nameservers
    # fd30:366:4000::1 = 1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.4.6.6.3.0.3.d.f.ip6.arpa.
    local-data: "1.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.4.6.6.3.0.3.d.f.ip6.arpa. 3600 IN PTR ns1.scarjit.dn42."
    # fd30:366:4000::2 = 2.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.4.6.6.3.0.3.d.f.ip6.arpa.
    local-data: "2.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.0.4.6.6.3.0.3.d.f.ip6.arpa. 3600 IN PTR ns1.linnenberg.dn42."

# Forward all non-DN42 queries to NextDNS
forward-zone:
    name: "."
    forward-addr: 45.90.28.169
    forward-addr: 45.90.30.169
    forward-addr: 2a07:a8c0::21:d1bc
    forward-addr: 2a07:a8c1::21:d1bc

# DN42 domains - use DN42 anycast resolvers
# Note: Anycast DNS may take time to become reachable as BGP routes propagate
# The anycast addresses will automatically work once the network converges
forward-zone:
    name: "dn42"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# Reverse DNS for DN42 IPv4 ranges
forward-zone:
    name: "20.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "21.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "22.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "23.172.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "10.in-addr.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# Reverse DNS for DN42 IPv6 range (fd00::/8)
forward-zone:
    name: "d.f.ip6.arpa"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

# Other DN42 affiliated TLDs (based on DN42 wiki)
forward-zone:
    name: "neo"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1

forward-zone:
    name: "hack"
    forward-addr: 172.20.0.53
    forward-addr: 172.23.0.53
    forward-addr: fd42:d42:d42:54::1
    forward-addr: fd42:d42:d42:53::1
